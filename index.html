<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Satellites</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style media="screen">
      #map{
        height: 600px;
        width: 100%
      }
    </style>
  </head>

  <body>
    <div class="container" align="center">
      <h1>Find nearest Satellite</h1>
      <p>Find a place on the map and click to drop a pin.</p>
      <p>Then click the button below to find which satellites are closest.</p>
      <div id="map"></div>
      <br>
      <p id="currentLat"></p>
      <p id="currentLng"></p>
      <button onclick="getSats()" type="button" class="btn btn-primary">Find Satellites</button>
    </div>
    <div class="container">
      <ol id="output"></ol>
    </div>

    <script type="text/javascript">
      var map;
      var marker = null;
      var latitude = null;
      var longitude = null;
      var requestURL;

      function initMap() {
        var london = {lat:51.316302085018876,lng:-0.1139043506334474}
        map = new google.maps.Map(document.getElementById('map'), {
          zoom:2.5,
          center: london,
          mapTypeId: 'terrain'
        });

        // Listen for click on map calls addMarker function
        map.addListener('click', function(event) {
          marker.setMap(null);
          addMarker(event.latLng);
        });
        addMarker(london);
      }

      // Removes current marker and adds new marker
      function addMarker(location){
        marker = new google.maps.Marker({
          position: location,
          map: map,
        });
        // Assign lat and lng to variable, log to console
        // and use in URL for GET request
        latitude = marker.getPosition().lat();
        longitude = marker.getPosition().lng();
        requestURL = "https://www.n2yo.com/rest/v1/satellite/above/"+latitude+"/"+longitude+"/0/10/0/&apiKey=[ADD_API_KEY]";
        document.getElementById('currentLat').innerHTML = "Latitude: " + latitude;
        document.getElementById('currentLng').innerHTML = "Longitude: " + longitude;
      }
    </script>

    <script type="text/javascript">
      function load(url, callback) {
        var xhr;
        if(typeof XMLHttpRequest !== 'undefined') xhr = new XMLHttpRequest();
        else {
          // Check for browser compatability
          var versions = ["Microsoft.XmlHttp",
                          "MSXML2.XmlHttp",
                          "MSXML2.XmlHttp.3.0",
                          "MSXML2.XmlHttp.4.0",
                          "MSXML2.XmlHttp.5.0"];
          for (var i = 0, len = versions.length; i < len; i++) {
            try {
              xhr = new ActiveXObject(versions[i]);
              break;
            }
            catch(e) {}
          } // end for
        }
      xhr.onreadystatechange = loadCallback;

      function loadCallback() {
        if (xhr.readyState < 4) {
          return;
        }
        if (xhr.status !== 200) {
          return;
        }
        // request parsed OK
        if (xhr.readyState === 4) {
          callback(xhr);
        }
      }
      xhr.open('GET', requestURL, true);
      xhr.send('');
   }
   // 'Find Satellites' button calls this function
   function getSats() {
      load(requestURL, function(xhr) {
        var data = xhr.responseText;
        var json = JSON.parse(data);
        console.log(data);
        alert("There are currently "+json.info.satcount+" Satellites above pin location \nwithin a 10 degree range. \nClick ok and scroll down to see Satallite list.")

        // Create a list out of Satallite names to appear below button
        var output = document.getElementById('output');
        output.innerHTML = '<h2>Here are the list of Satallite names</h2>'
        for (var i = 0; i < json.info.satcount; i++) {
          output.innerHTML += '<li>'+json.above[i].satname+'</li>'
          }
      })
    }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChJyZjKYrfGiKu3b-K6T_LWyMl8Jl8CYc&callback=initMap"
    async defer></script>
  </body>
</html>
